(function(e,t){typeof define=="function"&&define.amd?define(["$"],t):typeof exports=="object"?module.exports=t():e.Calendar=t(window.Zepto||window.jQuery||$)})(this,function(e){e.fn.Calendar=function(n){var r=[];return e(this).each(function(){var i=new t,s=e.extend({target:e(this)},n);i.init(s),r.push(i)}),r};var t=function(){this.monthArr=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],this.dayArr=["日","一","二","三","四","五","六"];var e=Math.random().toString().replace(".","");this.id="calendar_"+e,this.calendarContainer,this.settings={},this.isShow=!1,this.autohide=!0,this.toolbarTpl='<div class="ui-calendar-toolbar clearfix"><a class="js-calendar-submit">确定</a><a class="js-clear">清空</a><a class="ui-calendar-today">现在</a><a class="ui-calendar-close">关闭</a></div>',this.timeTpl='<div class="ui-calendar-time clearfix"><select class="js-calendar-hours">时</select>:<select class="js-calendar-minutes">分</select>:<select class="js-calendar-second">秒</select></div>',this.dateArr=[],this.maxDays=9999};return t.prototype={separator:"-",defaultDate:new Date,setRange:function(t){this.range=e.extend([null,null],t)},init:function(t){e("body").append('<div class="ui-calendar clearfix" id="'+this.id+'"><div class="ui-calendar-pannel clearfix" data-role="pannel"><span class="ui-calendar-control" data-role="prev-year">&lt;&lt;</span><span class="ui-calendar-control" data-role="prev-month">&lt;</span><span class="ui-calendar-control month" data-role="current-month"></span><span class="ui-calendar-control year" data-role="current-year"></span><span class="ui-calendar-control" data-role="next-month">&gt;</span><span class="ui-calendar-control" data-role="next-year">&gt;&gt;</span></div><div class="calendar-header clearfix"></div><div class="c_days clearfix"></div></div>'),this.calendarContainer=e("#"+this.id);var n=this;this.settings=e.extend({},this.settings,t),this.maxDays=this.settings.maxdays||this.maxDays,this.mutilSeparator=this.settings.mutilSeparator||",",this.settings.target&&e(this.settings.target).size()&&(e(this.settings.target)[0].nodeType===1?this.settings.focusDate=this.settings.focusDate||e(this.settings.target).val():this.settings.focusDate=this.settings.focusDate||e(this.settings.target).prev().val()||"");if(this.settings.focusDate&&!this.settings.multiple){var r=this.settings.focusDate.split(" ")[0].split(this.separator),i=this.settings.focusDate.split(" ")[1]||"00:00:00";this.defaultDate=new Date(r[0],parseInt(r[1])-1,r[2],i.split(":")[0],i.split(":")[1],i.split(":")[2])}if(this.settings.focusDate&&this.settings.multiple){var s=this.settings.focusDate.split(",");for(var o=s.length-1;o>=0;o--){var u=s[o],r=u.split(this.separator);this.dateArr.push(new Date(r[0],parseInt(r[1])-1,r[2]))}this.defaultDate=this.dateArr[0],n._dateInArr(n.defaultDate,n.dateArr)||n.dateArr.push(n.date)}this.settings.multiple&&(this.settings.toolbar=!0),this.settings.toolbar&&(this.autohide=!1);var a=this.settings.zIndex||1;this.calendarContainer.css("zIndex",a),this.date=this.defaultDate,this.setRange(this.settings.range),this.settings.time&&(this.settings.toolbar=!0,this.autohide=!1,this.showTime()),this.showToolbar(),this.bindEvent(),this.settings.target?this.hide():(this.autohide=!1,this.show())},showToolbar:function(){this.settings.toolbar&&this.calendarContainer.append(this.toolbarTpl)},showTime:function(){this.calendarContainer.append(this.timeTpl);var t=this;for(var n=0,r=60;n<r;n++)n<24&&e(".js-calendar-hours",this.calendarContainer).append("<option>"+t._getTowNum(n)+"</option>"),e(".js-calendar-minutes",this.calendarContainer).append("<option>"+t._getTowNum(n)+"</option>"),e(".js-calendar-second",this.calendarContainer).append("<option>"+t._getTowNum(n)+"</option>");var i=this.date,s=t._getTowNum(i.getHours())+":"+t._getTowNum(i.getMinutes())+":"+t._getTowNum(i.getSeconds());e(".js-calendar-hours",this.calendarContainer).val(t._getTowNum(i.getHours())),e(".js-calendar-minutes",this.calendarContainer).val(t._getTowNum(i.getMinutes())),e(".js-calendar-second",this.calendarContainer).val(t._getTowNum(i.getSeconds()))},show:function(){this.calendarContainer.show(),this.date=this.defaultDate,this.formatDate(),this.renderHeader(),this.isShow=!0,this.setPosition(),this.settings.show&&this.settings.show(this.calendarContainer);var e=this;this.timer=setInterval(function(){e.setPosition.call(e)},1e3)},hide:function(){this.calendarContainer.hide(),this.isShow=!1,this.settings.hide&&this.settings.hide(this.calendarContainer),clearInterval(this.timer)},setPosition:function(){var t=0,n=0;this.settings.target&&e(this.settings.target).size()&&(e(this.settings.target)[0].nodeType===1?(n=e(this.settings.target).offset().top+e(this.settings.target).outerHeight(),t=e(this.settings.target).offset().left):(n=e(this.settings.target).prev().offset().top+e(this.settings.target).prev().outerHeight(),t=e(this.settings.target).prev().offset().left),this.calendarContainer.css({top:n,left:t}))},setDate:function(e){var t=this,n;if(typeof e=="object")t.defaultDate=e,n=e.getFullYear()+t.separator+t._getTowNum(e.getMonth()+1)+t.separator+t._getTowNum(e.getDate()),t.settings.time&&(n+=" "+t._getTowNum(e.getHours())+":"+t._getTowNum(e.getMinutes())+":"+t._getTowNum(e.getSeconds()));else{var r=e.split(" "),i=r[0],s=r[1]||"00:00:00",o=i.split(t.separator);t.defaultDate=new Date(o[0],parseInt(o[1])-1,o[2],s.split(":")[0],s.split(":")[1],s.split(":")[2]),n=e}return t.date=t.defaultDate,n},bindEvent:function(){var t=this;e(".ui-calendar-control[data-role]",t.calendarContainer).click(function(){return t.go[e(this).data("role")].call(t),!1}),e(t.calendarContainer).click(function(){return!1}),e(".c_days",t.calendarContainer).delegate("li","click",function(){t.settings.beforeSelect&&t.settings.beforeSelect(t.date,t.calendarContainer);if(e(this).hasClass("disabled"))return!1;var n=e(this).data("value");t.setDate(n);if(t.settings.multiple)if(!e(this).hasClass("focus")){if(t.maxDays<=t.dateArr.length)return t.settings.overdays&&t.settings.overdays(t.maxDays,t.dateArr,t.calendarContainer),!1;t.dateArr.push(t.defaultDate)}else t._removeDate(t.defaultDate,t.dateArr);else t.dateArr=[t.date];return t.formatDate(),t.renderHeader(),t.settings.selected&&t.settings.selected(t.date,t.calendarContainer),t.settings.target&&e(t.settings.target).size()&&e(t.settings.target)[0].nodeType===1&&t.autohide&&(e(t.settings.target).val(n),t.hide(),t.settings.afterSelected&&t.settings.afterSelected(e(t.settings.target),t.date,t.calendarContainer)),!1}),e(".ui-calendar-toolbar",t.calendarContainer).delegate("a","click",function(){if(e(this).hasClass("js-calendar-submit")){t.settings.selected&&t.settings.selected(t.dateArr,t.calendarContainer),t.dateArr.length===0&&t.dateArr.push(e(".focus",t.calendarContainer).data("value"));var n=t._toString(t.dateArr);i=n.join(t.mutilSeparator),t.settings.time&&(i+=" "+e(".js-calendar-hours",t.calendarContainer).val()+":"+e(".js-calendar-minutes",t.calendarContainer).val()+":"+e(".js-calendar-second",t.calendarContainer).val()),e(t.settings.target).val(i),t.hide()}e(this).hasClass("ui-calendar-close")&&t.hide();if(e(this).hasClass("ui-calendar-today")){var r=new Date,i=t.setDate(r);t.date=r,t.hide(),e(t.settings.target).val(i)}e(this).hasClass("js-clear")&&(t.dateArr=[],e(t.settings.target).val(""),t.formatDate())}),t.settings.target&&(e(t.settings.target).bind("click",function(){return e(document).trigger("click"),t.show(),!1}),e(document).click(function(){t.isShow&&t.hide()}))},actionFlow:function(e,t){e.siblings(".ui-calendar-flow").length?e.siblings(".ui-calendar-flow").hide(300,function(){e[t](300)}):e[t](300)},go:{"next-month":function(){this.month+=1,this._getDate(),this.formatDate(),this.renderHeader()},"prev-month":function(){this.month-=1,this.changeDate()},"next-year":function(){this.year+=1,this.changeDate()},"prev-year":function(){this.year-=1,this.changeDate()},"current-year":function(t){var n=this;this.yearContainer?t||n.actionFlow(n.yearContainer,"toggle"):(this.yearContainer=e('<div class="ui-year-list ui-calendar-flow"/>'),this.calendarContainer.append(this.yearContainer),n.actionFlow(n.yearContainer,"show"),this.yearContainer.on("click","div",function(){var t=e(this).data("value");n.year=t,n.changeDate(),e(this).hasClass("cross")?n.go["current-year"].call(n,!0):n.actionFlow(n.yearContainer,"hide")}));var r=Math.floor(n.year/10);this.yearContainer.html(""),this.yearContainer.append('<div class="cross prevtenyear" data-value="'+((r-1).toString()+9)+'">...</div>');for(var i=0,s=10;i<s;i++){var o=r.toString()+i,u="";n.year==o&&(u=' class="current" '),this.yearContainer.append("<div "+u+' data-value="'+o+'">'+o+"</div>")}this.yearContainer.append('<div class="cross nexttenyear" data-value="'+((r+1).toString()+0)+'">...</div>')},"current-month":function(){var t=this;this.monthContainer?t.actionFlow(t.monthContainer,"toggle"):(this.monthContainer=e('<div class="ui-month-list ui-calendar-flow"/>'),this.calendarContainer.append(this.monthContainer),t.actionFlow(t.monthContainer,"show"),this.monthContainer.on("click","div",function(){var n=e(this).data("value");t.month=n,t.changeDate(),t.monthContainer.hide(300)})),this.monthContainer.html("");for(var n=0,r=this.monthArr.length;n<r;n++){var i=this.monthArr[n],s="";t.month==n&&(s=' class="current" '),this.monthContainer.append("<div "+s+' data-value="'+n+'">'+i+"</div>")}}},changeDate:function(){this._getDate(),this.formatDate(),this.renderHeader()},renderHeader:function(){e('[data-role="current-month"]',this.calendarContainer).html(this.monthArr[this.month]),e('[data-role="current-year"]',this.calendarContainer).html(this.year);var t="";for(var n=0,r=this.dayArr.length;n<r;n++)t+="<b>"+this.dayArr[n]+"</b>";e(".calendar-header",this.calendarContainer).html(t)},_getDate:function(){this.date=new Date(this.year,this.month,this.day)},formatDate:function(){var t=this.date;this.year=t.getFullYear(),this.month=t.getMonth(),this.day=t.getDate();var n=new Date(this.year,this.month+1,0),r=n.getDate(),i="<ul>",s=(new Date(this.year,this.month,1)).getDay(),o=new Date(this.year,this.month,0),u=o.getDate(),a=new Date(this.year,this.month+2,0);s>0&&(i+=this._getDay(u-s+1,u,"preday",o)),i+=this._getDay(1,r,"",this.date);var f=(new Date(this.year,this.month,r)).getDay();i+=this._getDay(1,6-f,"nextday",a),i+="</ul>",e("#"+this.id).find(".c_days").html(i)},_toString:function(e){var t=[],n=e.length;for(var r=0;r<n;r++){var i=e[r];typeof i=="string"&&(e[r]=new Date(i));for(var s=0;s<r;s++)if(i.getTime()<e[s]){var o=e[r];e[r]=e[s],e[s]=o}}for(var r=0,u=e.length;r<u;r++){var a=e[r],f=a.getFullYear(),l=this._getTowNum(a.getMonth()+1),c=this._getTowNum(a.getDate());t.push(f+this.separator+l+this.separator+c)}return t},_getDay:function(e,t,n,r){var i="",s=this.range[0],o=this.range[1];s&&(s=Date.parse(s)),o&&(o=Date.parse(o));for(var u=e;u<=t;u++){var a=n||"",f=r.getFullYear()+this.separator+this._getTowNum(r.getMonth()+1)+this.separator;f+=this._getTowNum(u);var l=new Date(r.getFullYear(),r.getMonth(),u),c=l.getTime();this.settings.multiple?this._dateInArr(l,this.dateArr)&&(a+=" focus"):c==+(new Date(this.defaultDate.getFullYear(),this.defaultDate.getMonth(),this.defaultDate.getDate()))&&(a+=" focus");if(s&&c<s||o&&c>o)a+=" disabled";this.settings.filter&&!this.settings.filter(c)&&(a+=" disabled"),i+='<li class="'+a+'" data-value="'+f+'">'+u+"</li>"}return i},_dateInArr:function(e,t){for(var n=t.length-1;n>=0;n--){var r=t[n],i=r;if(typeof r=="string"){var s=r.split(this.separator);i=new Date(s[0],parseInt(s[1])-1,s[2])}if(e.getTime()==i.getTime())return!0}},_removeDate:function(e,t){var n=[];for(var r=t.length-1;r>=0;r--){var i=t[r],s=i;if(typeof i=="string"){var o=i.split(this.separator);s=new Date(o[0],parseInt(o[1])-1,o[2])}if(e.getTime()==s.getTime())continue;n.push(s)}this.dateArr=n},_getTowNum:function(e){return("0"+e.toString()).substr(-2)}},t});