/*
 * Created with Sublime Text 2.
 * license: http://www.lovewebgames.com/jsmodule/index.html
 * User: 田想兵
 * Date: 2015-04-29
 * Time: 11:06:03
 * Contact: 55342775@qq.com
 */

(function(e,t){typeof define=="function"&&define.amd?define(["$"],t):typeof exports=="object"?module.exports=t():e.Upload=t(window.Zepto||window.jQuery||$)})(this,function(e){function t(){}return e.extend(t.prototype,{init:function(e){window.uploadCount=window.uploadCount||0,window.uploadCount++;var t=Math.random().toString().replace(".","");this.id="upload_"+t+window.uploadCount.toString(),this.settings=e,this.settings.iframe=!0,this.url=this.settings.url,this.name=this.settings.name||"files",this.target=this.settings.target,this.postTarget=this.settings.postTarget,typeof this.settings.autoPost=="undefined"?this.autoPost=!0:this.autoPost=this.settings.autoPost,this.createIframe(),this.createFile(),this.bindEvent(),this.bindFileChange()},createIframe:function(){this.frameId="iframe_upload";if(e("#"+this.frameId).length==0){var t='<iframe src="about:blank" id="'+this.frameId+'" name="'+this.frameId+'" width="0" height="0" frameborder="0"></iframe>';e("body").append(t)}this.frame=e("#"+this.frameId)},createFile:function(){var t=this;t.form&&t.form.remove(),t.form=e('<form method="post" ENCTYPE="multipart/form-data"><input type="file" style="position:absolute;top:0;left:0;width:1px;height:1px;opacity:0;" id="'+t.id+'" name="'+t.name+'"/></form>'),t.form.attr("target",t.frameId),t.form.css({height:0,widht:0,padding:0}),t.form.attr("action",t.url),e("body").append(t.form),t.fileInput=e("#"+t.id),this.bindFileChange()},postFrame:function(t,n,r){var i=t.value.split("."),s=i[i.length-1],o=this,u=this.settings.accept&&this.settings.accept.split(",")||[],a=!1;for(var f=u.length-1;f>=0;f--){var l=new RegExp(u[f],"i");l.exec(s)&&(a=!0)}if(!a&&u.length){var c="文件格式错误,支持格式："+this.settings.accept;return e.alert?e.alert(c):alert(c),!1}return this.form.submit(),this.frame.off("load"),this.frame.on("load",function(){var t=e(e(this.contentWindow.document).find("body")),n=t.children()[0],i=t.html();n&&n.nodeType==1&&(i=n.innerHTML),typeof i=="string"&&o.settings.type==="json"&&(i=(new Function("return "+i))()),o.settings.callback&&o.settings.callback.call(o,i,o.fileInput,o.name,o.target,r)}),o.createFile(),!0},touch:function(t,n){function i(e){return n.call(this,e)}var r;e(t).on("click",i),e(t).on("touchmove",function(e){r=!0}).on("touchend",function(e){e.preventDefault();if(!r){var t=n.call(this,e,"touch");t||(e.preventDefault(),e.stopPropagation())}r=!1})},bindEvent:function(t){var n=this;this.touch(e(this.target),function(t,r){return e(this).parent().siblings().size()>=n.settings.max?n.settings.maxCallback&&n.settings.maxCallback(this):e(n.fileInput).trigger("click"),!1}),n.bindFileEvent(),this.postTarget&&this.touch(e(this.postTarget),function(e,t){n.args.length&&n.postFrame.apply(n,n.args)&&n.settings.startUpload&&n.settings.startUpload.apply(n,n.args)})},bindFileEvent:function(){var t=this;e(this.fileInput).click(function(e){e.stopPropagation()})},bindFileChange:function(){var t=this;e(t.fileInput).off("change"),e(t.fileInput).on("change",function(e){var n=/^image\//i,r=e.target.files,i="up_"+Math.random().toString().replace(".","");t.args=[this,e,i],t.settings.selected&&t.settings.selected.call(this,this,e,i),t.settings.iframe&&t.autoPost&&t.postFrame(this,e,i)&&t.settings.startUpload&&t.settings.startUpload(t.fileInput,t.target,i)})}}),t});