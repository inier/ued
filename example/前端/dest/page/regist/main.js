/*
 * Created with Sublime Text 2.
 * license: http://www.lovewebgames.com/jsmodule/index.html
 * User: 田想兵
 * Date: 2015-03-16
 * Time: 20:27:54
 * Contact: 55342775@qq.com
 */

(function(e,t){typeof define=="function"&&define.amd?define("dialog",["$"],t):typeof exports=="object"?module.exports=t():e.Dialog=t(window.Zepto||window.jQuery||$)})(this,function(e){e.fn.Dialog=function(n){var r=[];return e(this).each(function(){var i=new t,s=e.extend({trigger:e(this)},n);i.init(s),r.push(i)}),r},e.Dialog=function(n){if(n.type==="alert"){var r=new t,i='<div class="ui-alert-title">'+n.content+"</div>",s="";n.button?(typeof n.button=="boolean"&&(n.button="确定"),s='<p class="ui-dialog-action"><button class="ui-alert-submit  js-dialog-close">'+n.button+"</button></p>"):n.timer||(n.timer=3e3),i+=s;var o=e.extend({target:i,animate:!0,show:!0,mask:!0,className:"ui-alert",afterHide:function(e){this.dispose(),n.callback&&n.callback()}},n);r.init(o),n.timer&&setTimeout(function(){r.dispose(),n.callback&&n.callback()},n.timer),r.touch(r.mask,function(){r.dispose(),n.callback&&n.callback()})}if(n.type==="confirm"){var u=new t,i='<div class="ui-confirm-title">'+n.content+"</div>",s="";n.buttons||(n.buttons=[{yes:"确定"},{no:"取消"}]);var a="";for(var f=0,l=n.buttons.length;f<l;f++){var c=n.buttons[f];c.yes&&(a+='<td><button class="ui-confirm-submit " data-type="yes">'+c.yes+"</button></td>"),c.no&&(a+='<td><button class="ui-confirm-no" data-type="no">'+c.no+"</button></td>"),c.close&&(a+='<td><button class="ui-confirm-close js-dialog-close" data-type="close">'+c.close+"</button></td>")}s='<table class="ui-dialog-action"><tr>'+a+"</tr></table>",i+=s;var h=e.extend({target:i,animate:!0,show:!0,mask:!0,className:"ui-alert",afterHide:function(e){this.dispose()},beforeShow:function(t){u.touch(e(".ui-confirm-submit",t),function(){n.callback&&n.callback.call(u,"yes",t)}),u.touch(e(".ui-confirm-no",t),function(){n.callback&&n.callback.call(u,"no",t)}),u.touch(e(".ui-confirm-close",t),function(){n.callback&&n.callback.call(u,"close",t)})}},n);u.init(h)}},e.alert=function(t,n,r,i,s){var o={},u={zIndex:100,type:"alert"};typeof t=="object"?o=e.extend(u,t):o=e.extend(u,{content:t,button:n,timer:i,callback:r}),e.Dialog(e.extend(o,s))},e.confirm=function(t,n,r,i){var s={},o={zIndex:100,type:"confirm"};typeof t=="object"?s=e.extend(o,t):s=e.extend(o,{content:t,buttons:n,callback:r}),e.Dialog(e.extend(s,i))};var t=function(){var t=Math.random().toString().replace(".","");this.id="dialog_"+t,this.settings={},this.settings.closeTpl=e('<span class="ui-dialog-close js-dialog-close">x</span>'),this.settings.titleTpl=e('<div class="ui-dialog-title"></div>'),this.timer=null,this.showed=!1,this.mask=e()};return t.prototype={init:function(t){var n=this;this.settings=e.extend({},this.settings,t),this.settings.mask&&(this.mask=e('<div class="ui-dialog-mask"/>'),e("body").append(this.mask)),e("body").append('<div class="ui-dialog" id="'+this.id+'"></div>'),this.dialogContainer=e("#"+this.id);var r=this.settings.zIndex||10;this.dialogContainer.css({zIndex:r}),this.settings.className&&this.dialogContainer.addClass(this.settings.className),this.mask.css({zIndex:r-1}),this.settings.closeTpl&&this.dialogContainer.append(this.settings.closeTpl),this.settings.title&&(this.dialogContainer.append(this.settings.titleTpl),this.settings.titleTpl.html(this.settings.title)),this.bindEvent(),this.settings.show&&this.show()},touch:function(t,n){function i(e){return n.call(this,e)}var r;e(t).on("click",i),e(t).on("touchmove",function(e){r=!0}).on("touchend",function(e){e.preventDefault();if(!r){var t=n.call(this,e,"touch");t||(e.preventDefault(),e.stopPropagation())}r=!1})},bindEvent:function(){var t=this;this.settings.trigger&&(e(this.settings.trigger).click(function(){t.show()}),t.touch(e(this.settings.trigger),function(){t.show()})),e(this.dialogContainer).delegate(".js-dialog-close","click",function(){return t.hide(),!1}),e(window).keydown(function(e){e.keyCode===27&&t.showed&&t.hide()})},dispose:function(){this.dialogContainer.remove(),this.mask.remove(),this.timer&&clearInterval(this.timer)},hide:function(){var t=this;t.settings.beforeHide&&t.settings.beforeHide.call(t,t.dialogContainer),this.showed=!1,this.mask.hide(),this.timer&&clearInterval(this.timer),this.settings.animate?(this.dialogContainer.removeClass("zoomIn").addClass("zoomOut"),setTimeout(function(){t.dialogContainer.hide(),typeof t.settings.target=="object"&&e("body").append(t.dialogContainer.hide()),t.settings.afterHide&&t.settings.afterHide.call(t,t.dialogContainer)},500)):(this.dialogContainer.hide(),typeof this.settings.target=="object"&&e("body").append(this.dialogContainer),this.settings.afterHide&&this.settings.afterHide.call(this,this.dialogContainer))},show:function(){typeof this.settings.target=="string"?/^(\.|\#\w+)/gi.test(this.settings.target)?this.dailogContent=e(this.settings.target):this.dailogContent=e("<div>"+this.settings.target+"</div>"):this.dailogContent=this.settings.target,this.mask.show(),this.dailogContent.show(),this.height=this.settings.height||"auto",this.width=this.settings.width||"auto",this.dialogContainer.append(this.dailogContent).show().css({height:this.height,width:this.width}),this.settings.beforeShow&&this.settings.beforeShow.call(this,this.dialogContainer),this.showed=!0,e(this.settings.trigger).blur(),this.setPosition();var t=this;this.timer&&clearInterval(this.timer),this.timer=setInterval(function(){t.setPosition()},1e3),this.settings.animate&&this.dialogContainer.addClass("zoomIn").removeClass("zoomOut").addClass("animated")},setPosition:function(){if(this.showed){var e=this;this.dialogContainer.show(),this.height=this.settings.height,this.width=this.settings.width,isNaN(this.height)&&(this.height=this.dialogContainer.outerHeight&&this.dialogContainer.outerHeight()||this.dialogContainer.height()),isNaN(this.width)&&(this.width=this.dialogContainer.outerWidth&&this.dialogContainer.outerWidth()||this.dialogContainer.width());var t=this.settings.clientHeight||document.documentElement.clientHeight||document.body.clientHeight,n=this.settings.clientWidth||document.documentElement.clientWidth||document.body.clientWidth,r=this.width/2,i=this.height/2,s=n/2-r,o=t/2-i;s=Math.max(0,s),o=Math.max(0,o),e.dialogContainer.css({position:"fixed",top:o,left:s})}}},t}),function(e,t){typeof define=="function"&&define.amd?define("page/regist/main",["$","dialog"],t):e.Index=t($,Dialog)}(this,function(e,t){return{init:function(){function n(t,n){e(t).nextAll(".tips").show().children().removeClass("error").addClass("ok").html(n),e(t).removeClass("error")}function r(t,n){e(t).nextAll(".tips").show().children().removeClass("ok").addClass("error").html(n),e(t).addClass("error")}function i(i,s){var o=e(i).data("type"),u=e(i).val();if(u.length==0)return!1;switch(o){case"email":var a=/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/;if(a.test(u)){if(s)return;var f=e(i).data("validate");e.post(f,{user_email:u},function(e){e.status?(n(i,""),t.email=!0):(r(i,e.msg),t.email=!0)})}else r(i,"邮箱格式错误"),t.email=!1;break;case"phone":var a=/^[1]\d{10}$/;if(a.test(u)){if(s)return;var f=e(i).data("validate");e.post(f,{user_mobile:u},function(e){e.status?(n(i,""),t.phone=!0):(r(i,e.msg),t.phone=!0)})}else r(i,"手机号码格式错误"),t.phone=!1;break;case"msg":if(u.length>0){if(s)return;e.post(e(i).data("validate"),{value:e(i).val()},function(e){e.status?(n(i,""),t.msg=!0):(r(i,"短信验证码错误！"),t.msg=!1)},"json")}break;case"pwd":u.length>=6&&u.length<32?(n(i,""),t.pwd=!0):(t.pwd=!1,r(i,"登录密码必须在6-32个字符之间"));break;case"pwdAgin":u==e('[data-type="pwd"]').val()?(n(i,""),t.pwdAgin=!0):(t.pwdAgin=!1,r(i,"两次输入不一致"))}}var t={email:!1,phone:!1,msg:!1,pwd:!1,pwdAgin:!1};e(".txt-input").focus(function(){e(this).addClass("focus"),e(this).nextAll(".tips").show()}).blur(function(t,n){e(this).removeClass("focus"),i(this,n)}),e("[required]").each(function(){e(this).blur(function(){e(this).val().length==0&&r(e(this),e(this).attr("required-msg"))})}),e("#js-btn-getValidate").click(function(){if(!e(this).hasClass("sended")){e(this).addClass("sended");var t=this;e.post(e(this).data("ajax"),function(n){if(n.status){var r=59;e(t).nextAll(".tips").show().children().removeClass("ok").removeClass("error").html("已发送，1分钟后重新获取.");var i=setInterval(function(){e(t).val("重新获取（"+r+"）"),r--,i<=0&&(clearInterval(i),e(t).val("获取短信验证码"),e(t).removeClass("sended"))},1e3)}else e.alert(n.msg),e(t).removeClass("sended")},"json")}}),e(".js-regist").submit(function(){var n=this;e("input",this).each(function(){e(this).trigger("blur",!0)});for(var r in t)if(!t[r])return!1;var i=e(this).attr("action"),s=e(this).serialize();return e.post(i,s,function(t){t.status?location.href=e(n).data("next"):e.alert(t.msg)}),!1}),e(".js-agreement").each(function(){var t=e(e(this).data("target"));e(this).Dialog({target:t,mask:!0,closeTpl:'<span class="ui-dialog-close ui-dialog-close2 js-dialog-close"></span>'})})}}});